<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Station Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh; color: #fff; padding: 20px;
        }
        .header { text-align: center; margin-bottom: 25px; }
        .header h1 {
            font-size: 2.2rem; margin-bottom: 8px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .header p { color: #8892b0; font-size: 1rem; }
        
        .status-bar {
            display: flex; flex-wrap: wrap; justify-content: center;
            gap: 12px; margin-bottom: 25px;
        }
        .status-item {
            background: rgba(255,255,255,0.1); padding: 10px 18px;
            border-radius: 20px; font-size: 0.85rem;
        }
        .online { color: #00ff88; }
        .offline { color: #ff6b6b; }
        .node-fallback {
            font-size: 0.7rem; color: #ffb86b; margin-left: 6px; background: rgba(255,184,107,0.06); padding: 2px 6px; border-radius: 8px; vertical-align: middle;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px; max-width: 1400px; margin: 0 auto;
        }
        .card {
            background: rgba(255,255,255,0.05); backdrop-filter: blur(10px);
            border-radius: 18px; padding: 22px; text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        .card-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .card-title {
            font-size: 0.75rem; color: #8892b0;
            text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;
        }
        .card-value { font-size: 2.2rem; font-weight: bold; }
        .card-unit { font-size: 1rem; color: #8892b0; margin-top: 4px; }
        
        .temp .card-value { color: #ff6b6b; }
        .hum .card-value { color: #4ecdc4; }
        .wind .card-value { color: #45b7d1; }
        .rain .card-value { color: #96ceb4; }
        .uv .card-value { color: #ffeaa7; }
        .dir .card-value { color: #a29bfe; font-size: 1.8rem; }
        
        .compass-container { position: relative; width: 80px; height: 80px; margin: 0 auto 10px; }
        .compass {
            width: 80px; height: 80px; border: 3px solid #a29bfe;
            border-radius: 50%; position: relative;
            background: rgba(162, 155, 254, 0.1);
        }
        .compass-arrow {
            position: absolute; left: 50%; bottom: 50%;
            /* Slightly shorten the arrow body so the tip sits away from the labels */
            width: 6px; height: 14px;
            background: linear-gradient(to top, #ff6b6b 12%, #a29bfe 60%);
            transform-origin: 50% 100%; /* pivot at bottom center */
            transform: translateX(-50%) rotate(0deg); /* bottom aligns with center via bottom:50% */
            transition: transform 0.5s ease;
            border-radius: 3px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }
        .compass-arrow::after {
            content: '';
            position: absolute; left: 50%; top: -6px; transform: translateX(-50%);
            width: 0; height: 0; border-left: 3px solid transparent; border-right: 3px solid transparent;
            border-bottom: 4px solid #a29bfe;
        }
        .compass-label {
            position: absolute; font-size: 0.7rem; color: #a29bfe; font-weight: bold;
        }
        .compass-n { top: 4px; left: 50%; transform: translateX(-50%); }
        .compass-s { bottom: 4px; left: 50%; transform: translateX(-50%); }
        .compass-e { right: 6px; top: 50%; transform: translateY(-50%); }
        .compass-w { left: 6px; top: 50%; transform: translateY(-50%); }
        
        .chart-container {
            grid-column: span 3;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px); border-radius: 18px; padding: 22px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-top: 10px;
        }
        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 18px; max-width: 1400px; margin: 20px auto;
        }
        .chart-box {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px); border-radius: 18px; padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .chart-title { 
            font-size: 1rem; margin-bottom: 15px; color: #8892b0;
            display: flex; align-items: center; gap: 8px;
        }
        .chart-title span { font-size: 1.2rem; }
        
        .table-container {
            max-width: 1400px; margin: 20px auto;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px); border-radius: 18px; padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .table-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
        }
        .table-title { font-size: 1.1rem; color: #8892b0; }
        .data-table {
            width: 100%; border-collapse: collapse;
            overflow: hidden; border-radius: 10px;
        }
        .data-table th, .data-table td {
            padding: 12px 8px; text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.85rem;
        }
        .data-table th {
            background: rgba(255,255,255,0.1); color: #8892b0;
            font-size: 0.7rem; text-transform: uppercase;
        }
        .data-table tr:hover { background: rgba(255,255,255,0.05); }
        .data-table tbody { max-height: 300px; overflow-y: auto; }
        
        .btn-container { 
            display: flex; justify-content: center; 
            gap: 10px; margin-top: 20px; flex-wrap: wrap;
        }
        .btn {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            border: none; padding: 12px 28px; border-radius: 25px;
            color: #fff; font-size: 0.9rem; cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,212,255,0.3);
        }
        .btn-danger {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
        }
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(255,65,108,0.3);
        }
        .btn-success {
            background: linear-gradient(90deg, #11998e, #38ef7d);
        }
        
        .signal-info {
            text-align: center; margin: 20px auto; padding: 15px;
            background: rgba(255,255,255,0.05); border-radius: 12px;
            display: inline-block;
        }
        .signal-info span { margin: 0 15px; }
        
        .footer {
            text-align: center; margin-top: 30px; padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1); color: #8892b0;
            font-size: 0.85rem;
        }
        
        .error {
            background: rgba(255,107,107,0.2); border: 1px solid #ff6b6b;
            padding: 15px; border-radius: 10px; margin: 15px auto; 
            text-align: center; max-width: 1400px;
        }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #1a1a2e; padding: 30px; border-radius: 20px;
            text-align: center; max-width: 400px; border: 1px solid rgba(255,255,255,0.1);
        }
        .modal-content h3 { margin-bottom: 15px; color: #ff6b6b; }
        .modal-content p { margin-bottom: 20px; color: #8892b0; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        
        @media (max-width: 768px) {
            .chart-row { grid-template-columns: 1fr; }
            .chart-container { grid-column: span 1; }
            .header h1 { font-size: 1.6rem; }
            .card-value { font-size: 1.8rem; }
            .data-table { font-size: 0.75rem; }
            .data-table th, .data-table td { padding: 8px 4px; }
        }
        
        .loading {
            text-align: center; padding: 40px; color: #8892b0;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; max-width: 1400px; margin: 20px auto;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px; padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stat-card h4 { color: #8892b0; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 10px; }
        .stat-row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 0.85rem; }
        .stat-label { color: #8892b0; }
        .stat-value { font-weight: bold; }
        .stat-value.high { color: #ff6b6b; }
        .stat-value.low { color: #4ecdc4; }
        .stat-value.avg { color: #ffeaa7; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå§Ô∏è Weather Station Dashboard</h1>
        <p>Low-Power Agricultural Monitoring System</p>
    </div>
    
    <div class="status-bar">
        <div class="status-item" id="connectionStatus">
            <span class="offline">‚óè</span> Connecting...
        </div>
        <div class="status-item" id="nodeStatus">
            <span class="offline">‚óè</span> Node 1: --
        </div>
        <div class="status-item">üìÖ <span id="currentDate">--</span></div>
        <div class="status-item">üïê <span id="liveTime">--:--:--</span></div>
        <div class="status-item">üì¶ Total Records: <span id="totalRecords">0</span></div>
    </div>
    
    <!-- Live Time Display -->
    <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 2.5rem; color: #00d4ff; font-weight: bold;" id="bigTime">--:--:--</div>
        <div style="color: #8892b0;">Last Update: <span id="lastUpdate">--:--:--</span></div>
    </div>
    
    <!-- Alert Box -->
    <div id="alertBox" style="max-width: 1400px; margin: 0 auto;"></div>
    
    <div id="errorContainer"></div>
    
    <!-- Sensor Cards -->
    <div class="dashboard">
        <div class="card temp">
            <div class="card-icon">üå°Ô∏è</div>
            <div class="card-title">Temperature</div>
            <div class="card-value"><span id="temperature">--</span></div>
            <div class="card-unit">¬∞C</div>
        </div>
        
        <div class="card hum">
            <div class="card-icon">üíß</div>
            <div class="card-title">Humidity</div>
            <div class="card-value"><span id="humidity">--</span></div>
            <div class="card-unit">%</div>
        </div>
        
        <div class="card wind">
            <div class="card-icon">üí®</div>
            <div class="card-title">Wind Speed</div>
            <div class="card-value"><span id="windSpeed">--</span></div>
            <div class="card-unit">m/s</div>
        </div>
        
        <div class="card dir">
            <div class="card-icon">üß≠</div>
            <div class="card-title">Wind Direction</div>
            <div class="compass-container">
                <div class="compass">
                    <span class="compass-label compass-n">N</span>
                    <span class="compass-label compass-s">S</span>
                    <span class="compass-label compass-e">E</span>
                    <span class="compass-label compass-w">W</span>
                    <div class="compass-arrow" id="compassArrow"></div>
                </div>
            </div>
            <div class="card-value"><span id="windDirection">--</span></div>
            <div class="card-unit"><span id="windDegrees">--</span>¬∞</div>
        </div>
        
        <div class="card rain">
            <div class="card-icon">üåßÔ∏è</div>
            <div class="card-title">Total Rainfall</div>
            <div class="card-value"><span id="totalRainfall">--</span></div>
            <div class="card-unit">mm</div>
        </div>
        
        <div class="card uv">
            <div class="card-icon">‚òÄÔ∏è</div>
            <div class="card-title">UV Index</div>
            <div class="card-value"><span id="uvIndex">--</span></div>
            <div class="card-unit" id="uvLevel">--</div>
        </div>
    </div>
    
    <!-- Signal Info -->
    <div style="text-align: center;">
        <div class="signal-info">
            üì° Signal: RSSI: <span id="rssi">--</span> dBm | SNR: <span id="snr">--</span> dB
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-row">
        <div class="stat-card">
            <h4>üå°Ô∏è Temperature Stats</h4>
            <div class="stat-row"><span class="stat-label">High:</span><span class="stat-value high" id="tempHigh">--</span></div>
            <div class="stat-row"><span class="stat-label">Low:</span><span class="stat-value low" id="tempLow">--</span></div>
            <div class="stat-row"><span class="stat-label">Average:</span><span class="stat-value avg" id="tempAvg">--</span></div>
        </div>
        <div class="stat-card">
            <h4>üíß Humidity Stats</h4>
            <div class="stat-row"><span class="stat-label">High:</span><span class="stat-value high" id="humHigh">--</span></div>
            <div class="stat-row"><span class="stat-label">Low:</span><span class="stat-value low" id="humLow">--</span></div>
            <div class="stat-row"><span class="stat-label">Average:</span><span class="stat-value avg" id="humAvg">--</span></div>
        </div>
        <div class="stat-card">
            <h4>üí® Wind Speed Stats</h4>
            <div class="stat-row"><span class="stat-label">Max:</span><span class="stat-value high" id="windHigh">--</span></div>
            <div class="stat-row"><span class="stat-label">Min:</span><span class="stat-value low" id="windLow">--</span></div>
            <div class="stat-row"><span class="stat-label">Average:</span><span class="stat-value avg" id="windAvg">--</span></div>
        </div>
        <div class="stat-card">
            <h4>‚òÄÔ∏è UV Index Stats</h4>
            <div class="stat-row"><span class="stat-label">Max:</span><span class="stat-value high" id="uvHigh">--</span></div>
            <div class="stat-row"><span class="stat-label">Min:</span><span class="stat-value low" id="uvLow">--</span></div>
            <div class="stat-row"><span class="stat-label">Average:</span><span class="stat-value avg" id="uvAvg">--</span></div>
        </div>
    </div>
    
    <!-- Charts Row 1: Temperature & Humidity -->
    <div class="chart-row">
        <div class="chart-box">
            <div class="chart-title"><span>üå°Ô∏è</span> Temperature (Last 24 Hours)</div>
            <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-box">
            <div class="chart-title"><span>üíß</span> Humidity (Last 24 Hours)</div>
            <canvas id="humChart"></canvas>
        </div>
    </div>
    
    <!-- Charts Row 2: Wind Speed & Direction -->
    <div class="chart-row">
        <div class="chart-box">
            <div class="chart-title"><span>üí®</span> Wind Speed (Last 24 Hours)</div>
            <canvas id="windChart"></canvas>
        </div>
        <div class="chart-box">
            <div class="chart-title"><span>üß≠</span> Wind Direction Distribution</div>
            <canvas id="windDirChart"></canvas>
        </div>
    </div>
    
    <!-- Charts Row 3: Rainfall & UV Index -->
    <div class="chart-row">
        <div class="chart-box">
            <div class="chart-title"><span>üåßÔ∏è</span> Rainfall (Last 24 Hours)</div>
            <canvas id="rainChart"></canvas>
        </div>
        <div class="chart-box">
            <div class="chart-title"><span>‚òÄÔ∏è</span> UV Index (Last 24 Hours)</div>
            <canvas id="uvChart"></canvas>
        </div>
    </div>
    
    <!-- Recent Readings Table -->
    <div class="table-container">
        <div class="table-header">
            <div class="table-title">üìã Recent Readings</div>
            <!-- Date Range Filter -->
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <label style="color: #8892b0; font-size: 0.85rem;">From:</label>
                <input type="date" id="startDate" style="padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff;">
                <label style="color: #8892b0; font-size: 0.85rem;">To:</label>
                <input type="date" id="endDate" style="padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff;">
                <button class="btn" onclick="filterByDateRange()" style="padding: 8px 15px;">üîç Filter</button>
                <button class="btn" onclick="clearFilter()" style="padding: 8px 15px; background: linear-gradient(90deg, #636e72, #b2bec3);">Clear</button>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Temp (¬∞C)</th>
                        <th>Humidity (%)</th>
                        <th>Wind (m/s)</th>
                        <th>Direction</th>
                        <th>Rain (mm)</th>
                        <th>UV Index</th>
                        <th>RSSI</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr><td colspan="8" class="loading">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Buttons -->
        <div class="btn-container">
            <button class="btn btn-success" onclick="exportTodayCSV()">üì• Export Today's Data</button>
            <button class="btn" onclick="exportAllCSV()">üì• Export All Data</button>
            <button class="btn btn-danger" onclick="showResetModal()">üóëÔ∏è Reset All Data</button>
        </div>
    </div>
    
    <div class="footer">
        <p>Low-Power Weather Monitoring System for Agricultural Applications</p>    
    </div>
    
    <!-- Reset Confirmation Modal -->
    <div class="modal" id="resetModal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Reset All Data?</h3>
            <p>This will permanently delete ALL weather data from the database. This action cannot be undone!</p>
            <div class="modal-buttons">
                <button class="btn" onclick="hideResetModal()">Cancel</button>
                <button class="btn btn-danger" onclick="resetAllData()">Yes, Delete All</button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // FIREBASE CONFIGURATION - UPDATE THESE VALUES!
        // =====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDUFlR0TbOxjUB2tUqzm99Q7s51BLMZCMA",
            authDomain: "weather-monitoring-syste-2db7a.firebaseapp.com",
            databaseURL: "https://weather-monitoring-syste-2db7a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "weather-monitoring-syste-2db7a",
            storageBucket: "weather-monitoring-syste-2db7a.firebasestorage.app",
            messagingSenderId: "972477467288",
            appId: "1:972477467288:web:eb8837ffde1b715e5f1eed"
        };
        // =====================================================

        // Initialize Firebase
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showError("Failed to connect to Firebase. Check configuration.");
        }

        // Chart instances
        let tempChart, humChart, windChart, windDirChart, rainChart, uvChart;
        
        // Data storage
        const chartData = {
            labels: [],
            temp: [],
            hum: [],
            wind: [],
            windDir: [],
            rain: [],
            uv: []
        };
        
        // Wind direction counts for pie chart
        const windDirCounts = { N: 0, NE: 0, E: 0, SE: 0, S: 0, SW: 0, W: 0, NW: 0 };

        // Show error message
        function showError(message) {
            document.getElementById('errorContainer').innerHTML = 
                `<div class="error">‚ö†Ô∏è ${message}</div>`;
        }

        // Get UV level description
        function getUVLevel(uv) {
            if (uv <= 2) return 'Low';
            if (uv <= 5) return 'Moderate';
            if (uv <= 7) return 'High';
            if (uv <= 10) return 'Very High';
            return 'Extreme';
        }

        // Format timestamp to time string
        function formatTime(timestamp) {
            const hours = Math.floor((timestamp % 86400) / 3600);
            const minutes = Math.floor((timestamp % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Smooth animated compass update (shortest rotation + easing)
        let _compassCurrent = null; // current applied angle (may be fractional)
        let _compassTarget = null;  // target applied angle
        const _compassDebug = false;
        function updateCompass(degrees) {
            const arrow = document.getElementById('compassArrow');
            if (!arrow) return;

            degrees = Number(degrees);
            if (Number.isNaN(degrees)) return;

            // Normalize to [0,360)
            const target = ((degrees % 360) + 360) % 360;

            // Initialize immediately if first call
            if (_compassCurrent === null) {
                _compassCurrent = target;
                _compassTarget = target;
                arrow.style.transform = `translateX(-50%) rotate(${_compassCurrent}deg)`;
                return;
            }

            // Compute shortest delta from current to target
            let delta = ((target - _compassCurrent + 540) % 360) - 180;
            _compassTarget = _compassCurrent + delta;

            if (_compassDebug) console.debug('[compass] animate to', _compassTarget, 'from', _compassCurrent, 'delta', delta);

            // Start animation loop (if not already running)
            if (!_compassAnimating) startCompassAnimation(arrow);
        }

        let _compassAnimating = false;
        function startCompassAnimation(arrow) {
            _compassAnimating = true;
            function step() {
                const diff = _compassTarget - _compassCurrent;
                // spring-like smoothing: lerp + small damping
                _compassCurrent += diff * 0.18;
                // If close enough, snap to target and stop
                if (Math.abs(diff) < 0.2) {
                    _compassCurrent = _compassTarget;
                }
                arrow.style.transform = `translateX(-50%) rotate(${_compassCurrent}deg)`;

                if (Math.abs(_compassTarget - _compassCurrent) > 0.2) {
                    requestAnimationFrame(step);
                } else {
                    _compassAnimating = false;
                }
            }
            requestAnimationFrame(step);
        }

        // Initialize all charts
        function initCharts() {
            // Common chart options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        ticks: { color: '#8892b0', maxTicksLimit: 12 }, 
                        grid: { color: 'rgba(255,255,255,0.1)' } 
                    },
                    y: { 
                        ticks: { color: '#8892b0' }, 
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        beginAtZero: false
                    }
                }
            };

            // Temperature Chart
            tempChart = new Chart(document.getElementById('tempChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: chartData.temp,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255,107,107,0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { ...commonOptions }
            });

            // Humidity Chart
            humChart = new Chart(document.getElementById('humChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Humidity (%)',
                        data: chartData.hum,
                        borderColor: '#4ecdc4',
                        backgroundColor: 'rgba(78,205,196,0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { ...commonOptions }
            });

            // Wind Speed Chart
            windChart = new Chart(document.getElementById('windChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Wind Speed (m/s)',
                        data: chartData.wind,
                        borderColor: '#45b7d1',
                        backgroundColor: 'rgba(69,183,209,0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, beginAtZero: true } } }
            });

            // Wind Direction Pie Chart
            windDirChart = new Chart(document.getElementById('windDirChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#ff6b6b', '#ffa502', '#ffeaa7', '#7bed9f',
                            '#70a1ff', '#5352ed', '#a29bfe', '#ff6b81'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#8892b0' }
                        }
                    }
                }
            });

            // Rainfall Chart
            rainChart = new Chart(document.getElementById('rainChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Rainfall (mm)',
                        data: chartData.rain,
                        backgroundColor: 'rgba(150,206,180,0.7)',
                        borderColor: '#96ceb4',
                        borderWidth: 1
                    }]
                },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, beginAtZero: true } } }
            });

            // UV Index Chart
            uvChart = new Chart(document.getElementById('uvChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'UV Index',
                        data: chartData.uv,
                        borderColor: '#ffeaa7',
                        backgroundColor: 'rgba(255,234,167,0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, beginAtZero: true } } }
            });
        }

        // Update dashboard with latest data
        function updateDashboard(data) {
            if (!data) return;

            // Debug incoming payload to help diagnose missing timestamps
            if (window && window.console) console.debug('[updateDashboard] /latest payload:', data);

            document.getElementById('connectionStatus').innerHTML = 
                '<span class="online">‚óè</span> Connected';

            document.getElementById('temperature').textContent = 
                data.temperature !== undefined ? data.temperature.toFixed(1) : '--';
            document.getElementById('humidity').textContent = 
                data.humidity !== undefined ? data.humidity : '--';
            document.getElementById('windSpeed').textContent = 
                data.windSpeed !== undefined ? data.windSpeed.toFixed(2) : '--';
            document.getElementById('windDirection').textContent = 
                data.windDirection || '--';
            document.getElementById('windDegrees').textContent = 
                data.windDegrees !== undefined ? data.windDegrees : '--';
            document.getElementById('totalRainfall').textContent = 
                data.totalRainfall !== undefined ? data.totalRainfall.toFixed(1) : '--';
            document.getElementById('uvIndex').textContent = 
                data.uvIndex !== undefined ? data.uvIndex.toFixed(2) : '--';
            document.getElementById('uvLevel').textContent = 
                data.uvIndex !== undefined ? getUVLevel(data.uvIndex) : '--';
            document.getElementById('rssi').textContent = 
                data.rssi !== undefined ? data.rssi : '--';
            document.getElementById('snr').textContent = 
                data.snr !== undefined ? data.snr.toFixed(1) : '--';
            document.getElementById('lastUpdate').textContent = 
                data.receivedAt || new Date().toLocaleTimeString();
            document.getElementById('currentDate').textContent = 
                new Date().toLocaleDateString();
            
            // Node status (robust: parse receivedAt/timestamp safely, avoid epoch-zero and ms/seconds mixups)
            const nodeStatus = document.getElementById('nodeStatus');
            if (nodeStatus) {
                function parseLastSeen(d) {
                    // Try 'receivedAt' string first
                    if (d.receivedAt) {
                        const dt = new Date(d.receivedAt);
                        if (!Number.isNaN(dt.getTime()) && dt.getFullYear() >= 2000 && dt.getTime() <= Date.now() + 60000) return dt;
                    }
                    // Then try numeric timestamp (may be seconds or ms)
                    if (d.timestamp !== undefined && d.timestamp !== null) {
                        const t = Number(d.timestamp);
                        if (!Number.isNaN(t) && t > 0) {
                            // Heuristic: if timestamp < 1e11 it's seconds, otherwise treat as ms
                            const ms = (t < 1e11) ? t * 1000 : t;
                            const dt2 = new Date(ms);
                            if (!Number.isNaN(dt2.getTime()) && dt2.getFullYear() >= 2000 && dt2.getTime() <= Date.now() + 60000) return dt2;
                        }
                    }
                    return null;
                }

                let lastSeen = parseLastSeen(data);
                let usedFallback = false;

                if (!lastSeen) {
                    const hasValues = data.temperature !== undefined || data.humidity !== undefined || data.windSpeed !== undefined || data.rssi !== undefined || data.snr !== undefined;
                    if (hasValues) {
                        lastSeen = new Date();
                        usedFallback = true;
                        if (window && window.console) console.warn('[node status] missing timestamp in latest payload ‚Äî using receipt time', data);
                    }
                }

                if (!lastSeen) {
                    nodeStatus.innerHTML = '<span class="offline">‚óè</span> Node 1: No heartbeat';
                    nodeStatus.title = '';
                } else {
                    const seconds = Math.floor((Date.now() - lastSeen.getTime()) / 1000);
                    const ageText = seconds < 60 ? '<1m' : (seconds < 3600 ? `${Math.floor(seconds/60)}m` : (seconds < 86400 ? `${Math.floor(seconds/3600)}h` : `${Math.floor(seconds/86400)}d`));
                    const via = (data.rssi !== undefined || data.snr !== undefined) ? 'LoRa' : (data.wifiConnected ? 'Wi‚ÄëFi' : null);
                    const viaText = via ? ` (${via})` : '';
                    const online = seconds < 300; // 5 minutes
                    const fallbackBadge = usedFallback ? ' <span class="node-fallback" title="Missing timestamp in payload">no ts</span>' : '';
                    nodeStatus.innerHTML = `<span class="${online ? 'online' : 'offline'}">‚óè</span> Node 1: ${online ? 'Live' : 'Offline'}${viaText} ‚Äî ${ageText} ago${fallbackBadge}`;
                    nodeStatus.title = usedFallback ? 'No timestamp in payload; using receipt time' : ('Last seen: ' + lastSeen.toLocaleString());
                }
            }
            
            // Show alerts
            const alertBox = document.getElementById('alertBox');
            if (alertBox && data.alerts && data.alerts.length > 0) {
                alertBox.innerHTML = `<div class="error">‚ö†Ô∏è ALERTS: ${data.alerts.replace(/,/g, ' | ')}</div>`;
            } else if (alertBox) {
                alertBox.innerHTML = '';
            }

            // Update compass
            if (data.windDegrees !== undefined) {
                updateCompass(data.windDegrees);
            }
        }

        // Calculate and update statistics
        function updateStatistics(allData) {
            if (!allData || Object.keys(allData).length === 0) return;
            
            let temps = [], hums = [], winds = [], uvs = [];
            
            Object.values(allData).forEach(dayData => {
                Object.values(dayData).forEach(reading => {
                    if (reading.temperature && reading.temperature > -900) temps.push(reading.temperature);
                    if (reading.humidity && reading.humidity > -900) hums.push(reading.humidity);
                    if (reading.windSpeed !== undefined) winds.push(reading.windSpeed);
                    if (reading.uvIndex !== undefined) uvs.push(reading.uvIndex);
                });
            });
            
            if (temps.length > 0) {
                document.getElementById('tempHigh').textContent = Math.max(...temps).toFixed(1) + '¬∞C';
                document.getElementById('tempLow').textContent = Math.min(...temps).toFixed(1) + '¬∞C';
                document.getElementById('tempAvg').textContent = (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1) + '¬∞C';
            }
            
            if (hums.length > 0) {
                document.getElementById('humHigh').textContent = Math.max(...hums) + '%';
                document.getElementById('humLow').textContent = Math.min(...hums) + '%';
                document.getElementById('humAvg').textContent = (hums.reduce((a, b) => a + b, 0) / hums.length).toFixed(0) + '%';
            }
            
            if (winds.length > 0) {
                document.getElementById('windHigh').textContent = Math.max(...winds).toFixed(2) + ' m/s';
                document.getElementById('windLow').textContent = Math.min(...winds).toFixed(2) + ' m/s';
                document.getElementById('windAvg').textContent = (winds.reduce((a, b) => a + b, 0) / winds.length).toFixed(2) + ' m/s';
            }
            
            if (uvs.length > 0) {
                document.getElementById('uvHigh').textContent = Math.max(...uvs).toFixed(2);
                document.getElementById('uvLow').textContent = Math.min(...uvs).toFixed(2);
                document.getElementById('uvAvg').textContent = (uvs.reduce((a, b) => a + b, 0) / uvs.length).toFixed(2);
            }
        }

        // Load data for table and charts
        function loadAllData() {
            database.ref('/weather_data').on('value', (snapshot) => {
                const allData = snapshot.val();
                const tbody = document.getElementById('dataTableBody');
                
                if (!allData) {
                    tbody.innerHTML = '<tr><td colspan="8" class="loading">No data available</td></tr>';
                    document.getElementById('totalRecords').textContent = '0';
                    return;
                }
                
                // Reset chart data
                chartData.labels = [];
                chartData.temp = [];
                chartData.hum = [];
                chartData.wind = [];
                chartData.rain = [];
                chartData.uv = [];
                Object.keys(windDirCounts).forEach(k => windDirCounts[k] = 0);
                
                let allReadings = [];
                let totalCount = 0;
                
                // Collect all readings
                Object.entries(allData).forEach(([date, dayData]) => {
                    Object.entries(dayData).forEach(([timestamp, reading]) => {
                        totalCount++;
                        allReadings.push({ date, timestamp, ...reading });
                        
                        // Add to chart data (limit to last 288 = 24 hours at 5-min intervals)
                        if (chartData.labels.length < 288) {
                            const time = reading.receivedAt || formatTime(reading.timestamp);
                            chartData.labels.push(time);
                            chartData.temp.push(reading.temperature > -900 ? reading.temperature : null);
                            chartData.hum.push(reading.humidity > -900 ? reading.humidity : null);
                            chartData.wind.push(reading.windSpeed);
                            chartData.rain.push(reading.rainfall || 0);
                            chartData.uv.push(reading.uvIndex);
                            
                            // Count wind directions
                            if (reading.windDirection && windDirCounts[reading.windDirection] !== undefined) {
                                windDirCounts[reading.windDirection]++;
                            }
                        }
                    });
                });
                
                document.getElementById('totalRecords').textContent = totalCount;
                
                // Update statistics
                updateStatistics(allData);
                
                // Sort by timestamp descending and take last 20 for table
                allReadings.sort((a, b) => b.timestamp - a.timestamp);
                const recentReadings = allReadings.slice(0, 20);
                
                // Update table
                tbody.innerHTML = '';
                recentReadings.forEach(reading => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${reading.receivedAt || formatTime(reading.timestamp)}</td>
                        <td>${reading.temperature > -900 ? reading.temperature?.toFixed(1) : 'ERR'}</td>
                        <td>${reading.humidity > -900 ? reading.humidity : 'ERR'}</td>
                        <td>${reading.windSpeed?.toFixed(2) || '--'}</td>
                        <td>${reading.windDirection || '--'} (${reading.windDegrees || '--'}¬∞)</td>
                        <td>${reading.totalRainfall?.toFixed(1) || '0.0'}</td>
                        <td>${reading.uvIndex?.toFixed(2) || '--'}</td>
                        <td>${reading.rssi || '--'}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update all charts
                tempChart.data.labels = chartData.labels;
                tempChart.data.datasets[0].data = chartData.temp;
                tempChart.update();
                
                humChart.data.labels = chartData.labels;
                humChart.data.datasets[0].data = chartData.hum;
                humChart.update();
                
                windChart.data.labels = chartData.labels;
                windChart.data.datasets[0].data = chartData.wind;
                windChart.update();
                
                windDirChart.data.datasets[0].data = Object.values(windDirCounts);
                windDirChart.update();
                
                rainChart.data.labels = chartData.labels;
                rainChart.data.datasets[0].data = chartData.rain;
                rainChart.update();
                
                uvChart.data.labels = chartData.labels;
                uvChart.data.datasets[0].data = chartData.uv;
                uvChart.update();
            });
        }

        // Listen for latest data
        function startListening() {
            if (!database) {
                showError("Database not initialized");
                return;
            }
            
            database.ref('/latest').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateDashboard(data);
                }
            }, (error) => {
                console.error("Error:", error);
                showError("Error connecting to database: " + error.message);
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="offline">‚óè</span> Disconnected';
            });
        }

        // Export today's data to CSV
        function exportTodayCSV() {
            const today = new Date().toISOString().split('T')[0];
            database.ref(`/weather_data/${today}`).once('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    alert('No data available for today');
                    return;
                }
                
                let csv = 'Time,Temperature(C),Humidity(%),WindSpeed(m/s),WindDirection,WindDegrees,Rainfall(mm),TotalRainfall(mm),UVIndex,RSSI(dBm),SNR(dB)\n';
                
                Object.values(data).forEach(row => {
                    csv += `${row.receivedAt || ''},${row.temperature},${row.humidity},${row.windSpeed},${row.windDirection},${row.windDegrees},${row.rainfall || 0},${row.totalRainfall},${row.uvIndex},${row.rssi || ''},${row.snr || ''}\n`;
                });
                
                downloadCSV(csv, `weather_data_${today}.csv`);
            });
        }

        // Export all data to CSV
        function exportAllCSV() {
            database.ref('/weather_data').once('value', (snapshot) => {
                const allData = snapshot.val();
                if (!allData) {
                    alert('No data available');
                    return;
                }
                
                let csv = 'Date,Time,Temperature(C),Humidity(%),WindSpeed(m/s),WindDirection,WindDegrees,Rainfall(mm),TotalRainfall(mm),UVIndex,RSSI(dBm),SNR(dB)\n';
                
                Object.entries(allData).forEach(([date, dayData]) => {
                    Object.values(dayData).forEach(row => {
                        csv += `${date},${row.receivedAt || ''},${row.temperature},${row.humidity},${row.windSpeed},${row.windDirection},${row.windDegrees},${row.rainfall || 0},${row.totalRainfall},${row.uvIndex},${row.rssi || ''},${row.snr || ''}\n`;
                    });
                });
                
                downloadCSV(csv, `weather_data_all_${new Date().toISOString().split('T')[0]}.csv`);
            });
        }

        // Download CSV helper
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Show reset modal
        function showResetModal() {
            document.getElementById('resetModal').classList.add('show');
        }

        // Hide reset modal
        function hideResetModal() {
            document.getElementById('resetModal').classList.remove('show');
        }

        // Reset all data
        function resetAllData() {
            if (!database) {
                alert('Database not connected');
                return;
            }
            
            // Delete weather_data and latest
            Promise.all([
                database.ref('/weather_data').remove(),
                database.ref('/latest').remove()
            ]).then(() => {
                alert('All data has been deleted successfully!');
                hideResetModal();
                location.reload();
            }).catch((error) => {
                alert('Error deleting data: ' + error.message);
                hideResetModal();
            });
        }

        // Initialize everything
        window.onload = function() {
            initCharts();
            startListening();
            loadAllData();
            
            // Set default date range (today)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // Update live time every second
            updateLiveTime();
            setInterval(updateLiveTime, 1000);
            
            // Update date every minute
            setInterval(() => {
                document.getElementById('currentDate').textContent = 
                    new Date().toLocaleDateString();
            }, 60000);
        };
        
        // Live time update function
        function updateLiveTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            document.getElementById('liveTime').textContent = timeStr;
            document.getElementById('bigTime').textContent = timeStr;
        }
        
        
        // Filter by date range
        function filterByDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Clear current data
            chartData.labels = [];
            chartData.temp = [];
            chartData.hum = [];
            chartData.wind = [];
            chartData.rain = [];
            chartData.uv = [];
            Object.keys(windDirCounts).forEach(k => windDirCounts[k] = 0);
            
            // Load data for date range
            database.ref('/weather_data').once('value', (snapshot) => {
                const allData = snapshot.val();
                const tbody = document.getElementById('dataTableBody');
                
                if (!allData) {
                    tbody.innerHTML = '<tr><td colspan="8" class="loading">No data available</td></tr>';
                    return;
                }
                
                let filteredReadings = [];
                
                Object.entries(allData).forEach(([date, dayData]) => {
                    if (date >= startDate && date <= endDate) {
                        Object.entries(dayData).forEach(([timestamp, reading]) => {
                            filteredReadings.push({ date, timestamp, ...reading });
                            
                            const time = reading.receivedAt || formatTime(reading.timestamp);
                            chartData.labels.push(date.substring(5) + ' ' + time);
                            chartData.temp.push(reading.temperature > -900 ? reading.temperature : null);
                            chartData.hum.push(reading.humidity > -900 ? reading.humidity : null);
                            chartData.wind.push(reading.windSpeed);
                            chartData.rain.push(reading.rainfall || 0);
                            chartData.uv.push(reading.uvIndex);
                            
                            if (reading.windDirection && windDirCounts[reading.windDirection] !== undefined) {
                                windDirCounts[reading.windDirection]++;
                            }
                        });
                    }
                });
                
                document.getElementById('totalRecords').textContent = filteredReadings.length;
                updateStatistics({[startDate]: filteredReadings.reduce((acc, r) => { acc[r.timestamp] = r; return acc; }, {})});
                
                filteredReadings.sort((a, b) => b.timestamp - a.timestamp);
                const recentReadings = filteredReadings.slice(0, 50);
                
                tbody.innerHTML = '';
                if (recentReadings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="loading">No data for selected date range</td></tr>';
                } else {
                    recentReadings.forEach(reading => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${reading.date} ${reading.receivedAt || formatTime(reading.timestamp)}</td>
                            <td>${reading.temperature > -900 ? reading.temperature?.toFixed(1) : 'ERR'}</td>
                            <td>${reading.humidity > -900 ? reading.humidity : 'ERR'}</td>
                            <td>${reading.windSpeed?.toFixed(2) || '--'}</td>
                            <td>${reading.windDirection || '--'} (${reading.windDegrees || '--'}¬∞)</td>
                            <td>${reading.totalRainfall?.toFixed(1) || '0.0'}</td>
                            <td>${reading.uvIndex?.toFixed(2) || '--'}</td>
                            <td>${reading.rssi || '--'}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
                // Update charts
                tempChart.data.labels = chartData.labels;
                tempChart.data.datasets[0].data = chartData.temp;
                tempChart.update();
                
                humChart.data.labels = chartData.labels;
                humChart.data.datasets[0].data = chartData.hum;
                humChart.update();
                
                windChart.data.labels = chartData.labels;
                windChart.data.datasets[0].data = chartData.wind;
                windChart.update();
                
                windDirChart.data.datasets[0].data = Object.values(windDirCounts);
                windDirChart.update();
                
                rainChart.data.labels = chartData.labels;
                rainChart.data.datasets[0].data = chartData.rain;
                rainChart.update();
                
                uvChart.data.labels = chartData.labels;
                uvChart.data.datasets[0].data = chartData.uv;
                uvChart.update();
            });
        }
        
        // Clear filter
        function clearFilter() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            loadAllData();
        }
    </script>
</body>
</html>
